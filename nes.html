<html>
  <head>
    <style>
      body {
        background-color: #bbb;
        font-family: monospace;
        color: black;
      }

      a {
        color: black;
        font-weight: bold;
      }

      a:hover {
        color: red;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>

    <div style="text-align: center;">
    <canvas id="screen" style="margin: auto"></canvas>
    <br/>
    <a href="https://github.com/spikegrobstein/bloodya.nes">6502 ASM Source</a>
    </div>

    <script type="text/javascript" src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
    <script id="rom" type-"text/javascript" src="bloodya.nes.js"></script>

    <script type="text/javascript">
      // jsnes renderer jacked straight from the jsnes site with super minor modifications
      const SCREEN_WIDTH = 256;
      const SCREEN_HEIGHT = 240;
      const canvas = document.getElementById('screen');

      canvas.width = SCREEN_WIDTH;
      canvas.height = SCREEN_HEIGHT;

      const context = canvas.getContext("2d");
      var imageData = context.getImageData(
        0,
        0,
        SCREEN_WIDTH,
        SCREEN_HEIGHT
      );

      context.fillStyle = "black";
      // set alpha to opaque
      context.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

      // buffer to write on next animation frame
      var buf = new ArrayBuffer(imageData.data.length);
      // Get the canvas buffer in 8bit and 32bit
      var buf8 = new Uint8ClampedArray(buf);
      var buf32 = new Uint32Array(buf);

      // Set alpha
      for (var i = 0; i < buf32.length; ++i) {
        buf32[i] = 0xff000000;
      }

      // just run the thing.
      var romData = atob(romData);

      var nes = new jsnes.NES({
        onFrame: (buffer) => {
          var i = 0;
          for (var y = 0; y < SCREEN_HEIGHT; ++y) {
            for (var x = 0; x < SCREEN_WIDTH; ++x) {
              i = y * 256 + x;
              // Convert pixel from NES BGR to canvas ABGR
              buf32[i] = 0xff000000 | buffer[i]; // Full alpha
            }
          }

          // write buffer
          imageData.data.set(buf8);
          context.putImageData(imageData, 0, 0);
        }
      });

      nes.loadROM(romData);

      function nesLoop() {
        nes.frame();
        window.requestAnimationFrame(nesLoop);
      }

      nesLoop();

    </script>

  </body>
</body>
